# Polymarket Bot 交易系统风险排查报告

**排查时间**: 2026-01-31  
**系统版本**: V3 (Smart Probability)  
**排查范围**: 信号生成、执行层、风险管理、数据监控、外部环境

---

## 1. 信号生成层风险

### 1.1 🚨 已确认风险

#### A. ML 模型特征不匹配 (高优先级)
**状态**: 已确认  
**证据**: 日志显示 `AI Prediction Error: Feature shape mismatch, expected: 13, got 15`

**问题描述**:
- 代码中构造了 15 个特征，但加载的 ML 模型 (ml_model_v2.pkl) 只期望 13 个
- 新增的两个特征 `price_time_interaction` 和 `pricing_power_index` 未被模型识别
- 导致所有 AI 预测失败，系统退化为纯数学模型 (70% Math + 30% AI 混合失效)

**影响**:
- AI 增强功能完全失效
- 信号质量下降，Edge 计算可能偏离最优

**建议修复**:
```bash
# 重新训练模型以包含新特征
python3 polymarket-bot/train_ml.py

# 或回滚代码到特征匹配版本
# 修改 btc_15m_bot_v3.py 移除两个新增特征
```

#### B. Edge 极端值频繁触发 (中优先级)
**状态**: 已确认  
**证据**: 日志频繁出现 `Edge DOWN 极端值截断: -99.0% → -50.0%`

**问题描述**:
- 当市场接近结算时（剩余时间 < 2分钟），概率计算产生极端值
- 系统已实施 ±50% 硬截断保护，但这是事后补救而非根本解决

**影响**:
- 临近结算时的信号可能失真
- 截断逻辑可能导致交易机会误判

**建议**:
- 在剩余时间 < 2 分钟时自动暂停新信号生成
- 调整概率计算公式的时间衰减因子

### 1.2 ⚠️ 理论风险

#### C. OBI 过滤器移除后的信号质量
**状态**: 理论风险  
**证据**: 代码注释显示 `OBI filter removed per Sir's request`

**问题描述**:
- OBI (Order Book Imbalance) 过滤器已被移除
- 原本用于过滤与 Binance 订单流方向不一致的信号
- 当前仅依赖 Poly 流动性检查 (Ask Depth > $200)

**潜在影响**:
- 可能产生与主流市场方向相反的假信号
- 建议监控胜率变化，如果胜率下降需考虑恢复 OBI 过滤

#### D. 过度拟合风险
**状态**: 理论风险  
**证据**: train_ml.py 使用随机搜索和较少的数据量

**问题描述**:
- 模型每 3 小时自动重训练
- 如果训练数据量小 (<100 条)，可能导致过度拟合

**建议**:
- 增加最小训练数据阈值检查
- 添加交叉验证逻辑

---

## 2. 执行层风险

### 2.1 🚨 已确认风险

#### A. 赎回功能完全失效 (高优先级)
**状态**: 已确认  
**证据**: `NameResolutionError: Failed to resolve 'tx-relay.polymarket.com'`

**问题描述**:
- Gasless 赎回中继服务的 DNS 解析失败
- 所有自动赎回交易均失败
- 用户需要手动赎回，资金被锁定在合约中

**影响**:
- 每次交易后资金无法自动回笼
- 需要手动干预，增加操作成本

**建议修复**:
1. 检查 DNS 配置或更换 DNS 服务器
2. 添加备用赎回方式（直接链上交易）
3. 添加指数退避重试机制

#### B. 流动性检查频繁失败 (中优先级)
**状态**: 已确认  
**证据**: 大量 `流动性不足: Ask Depth $0 < $200` 日志

**问题描述**:
- 市场收盘前流动性急剧下降
- 系统正确拦截了这些交易，但这意味着实际可交易窗口变小

**影响**:
- 有效交易时间可能只有 10-12 分钟/周期
- 信号频繁但无法执行，产生"假阳性"

**建议**:
- 在流动性不足时直接暂停监控，减少资源消耗
- 调整交易时段，避开低流动性时间段

#### C. 配置文件路径问题 (中优先级)
**状态**: 已确认  
**证据**: `⚠️ 配置文件未找到，使用默认参数`

**问题描述**:
- bot.log 显示在 polymarket-bot/ 子目录中运行时找不到 config.json
- 系统回退到硬编码默认参数

**影响**:
- 实际使用的参数可能与预期不符
- 通过 adjust_params.py 修改的参数可能未生效

**建议修复**:
```python
# 在 btc_15m_bot_v3.py 中使用绝对路径
import os
CONFIG_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "config.json")
```

### 2.2 ⚠️ 理论风险

#### D. 滑点/滑点估计偏差
**状态**: 理论风险  
**证据**: 代码使用 `best_ask - 0.01` 作为 maker 价格

**潜在问题**:
- 假设能以最佳卖价 - 0.01 成交
- 在快速市场中，实际成交价可能偏离
- 未考虑订单簿深度对大额交易的影响

**建议**:
- 添加滑点追踪和记录
- 根据订单大小动态调整价格偏移

#### E. 订单执行延迟
**状态**: 理论风险  
**证据**: WebSocket 连接和 REST API 调用存在网络延迟

**潜在问题**:
- 从信号生成到订单提交有数百毫秒延迟
- 高频交易中可能导致价格变动

---

## 3. 风险管理风险

### 3.1 🚨 已确认风险

#### A. 当前仅为模拟交易模式 (高优先级)
**状态**: 已确认  
**证据**: config.json 中 `"paper_trade": true, "execution_enabled": false`

**问题描述**:
- 系统当前仅记录模拟交易，未实际下单
- 所有 Telegram 通知都标注为 [模拟交易]

**影响**:
- 无法产生实际收益
- 回测结果可能与实盘有偏差

**建议**:
- 确认是否准备进入实盘
- 进入实盘前需进行完整测试

#### B. 双实例运行 (中优先级)
**状态**: 已确认  
**证据**: 日志中所有记录都是重复的

**问题描述**:
- 两个 bot 实例同时运行
- 可能导致重复下单或资源竞争

**建议**:
```bash
# 检查并停止重复实例
ps aux | grep btc_15m_bot
sudo systemctl status polymarket-bot
```

### 3.2 ⚠️ 理论风险

#### C. Position Sizing 策略
**状态**: 理论风险  
**证据**: 固定 $100 交易金额

**潜在问题**:
- 使用固定金额而非凯利公式或波动率调整
- 未实现资金曲线回撤控制

**建议**:
- 基于胜率动态调整仓位
- 添加连续亏损后的降仓机制

#### D. 黑天鹅事件应对
**状态**: 理论风险  
**证据**: 无特定极端事件处理逻辑

**潜在问题**:
- Polymarket 曾暂停结算的历史
- Binance API 故障可能导致错误定价

**建议**:
- 添加数据源健康检查
- 设置单日最大损失限额
- 准备紧急停止开关

---

## 4. 数据/监控风险

### 4.1 🚨 已确认风险

#### A. 交易日志文件缺失 (高优先级)
**状态**: 已确认  
**证据**: 找不到 paper_trades.jsonl 文件

**问题描述**:
- 虽然 logger 已启动，但文件可能位于错误路径
- 影响回测和模型训练

**建议**:
```bash
# 检查实际日志路径
find /home/ubuntu/clawd -name "paper_trades*" 2>/dev/null
ls -la /home/ubuntu/clawd/polymarket-bot/*.jsonl
```

#### B. 未实现完整的异常检测 (中优先级)
**状态**: 已确认  
**证据**: AI 错误被记录但未触发告警

**问题描述**:
- 系统记录错误但不主动通知
- 监控仪表板可能未显示这些错误

### 4.2 ⚠️ 理论风险

#### C. 结算延迟影响
**状态**: 理论风险

**潜在问题**:
- Polymarket 结算可能需要数小时
- 资金利用率降低

---

## 5. 外部环境风险

### 5.1 ⚠️ 理论风险

#### A. 监管风险 (高优先级)
**状态**: 理论风险

**问题描述**:
- Polymarket 已被 CFTC 调查过
- 美国用户被禁止，但平台仍可能面临进一步监管

**应对**:
- 关注监管新闻
- 准备资金快速撤离方案

#### B. 流动性变化 (中优先级)
**状态**: 理论风险

**潜在问题**:
- 竞争对手进入可能导致流动性分散
- 大交易员退出可能影响价格发现

#### C. 智能合约风险 (中优先级)
**状态**: 理论风险

**潜在问题**:
- CTF Exchange 合约可能存在漏洞
- Gnosis Safe 多签配置安全性

---

## 6. 风险优先级与应对建议汇总

| 优先级 | 风险项 | 状态 | 建议行动 |
|-------|--------|------|---------|
| P0 | ML 特征不匹配 | 已确认 | 立即重新训练模型 |
| P0 | 赎回功能失效 | 已确认 | 修复 DNS/添加备用方案 |
| P0 | 仅为模拟模式 | 已确认 | 确认是否进入实盘 |
| P1 | 双实例运行 | 已确认 | 停止重复实例 |
| P1 | 交易日志缺失 | 已确认 | 检查文件路径 |
| P1 | 配置文件路径问题 | 已确认 | 使用绝对路径 |
| P2 | Edge 极端值频繁 | 已确认 | 添加时间过滤 |
| P2 | 流动性不足 | 已确认 | 优化交易时段 |
| P2 | 监管风险 | 理论 | 持续关注 |
| P3 | 过度拟合 | 理论 | 增加数据阈值 |
| P3 | Position Sizing | 理论 | 实现动态仓位 |

---

## 7. 立即行动清单

### 7.1 今天必须完成
1. ✅ 修复 ML 模型特征不匹配问题
2. ✅ 检查并停止重复运行的 bot 实例
3. ✅ 修复 config.json 路径问题

### 7.2 本周完成
1. 📋 修复赎回功能 DNS 问题
2. 📋 确认交易日志文件位置
3. 📋 决定是否进入实盘交易
4. 📋 添加数据源健康检查

### 7.3 持续监控
1. 📊 监控胜率变化（OBI 移除后）
2. 📊 跟踪 Edge 极端值触发频率
3. 📊 关注 Polymarket 监管动态

---

**报告生成**: 2026-01-31  
**下次复查建议**: 2 周后或进入实盘前
